(function(a){if(typeof define==="function"&&define.amd){define(["JSRootPainter","THREE_ALL"],a)}else{if(typeof JSROOT=="undefined"){throw new Error("JSROOT is not defined","JSRootGeoPainter.js")}if(typeof JSROOT.Painter!="object"){throw new Error("JSROOT.Painter is not defined","JSRootGeoPainter.js")}if(typeof THREE=="undefined"){throw new Error("THREE is not defined","JSRootGeoPainter.js")}a(JSROOT)}}(function(a){if(typeof define==="function"&&define.amd){a.loadScript("$$$style/JSRootGeoPainter.css")}a.GEO={};a.GEO.createCube=function(c){var e=new THREE.Geometry();e.vertices.push(new THREE.Vector3(c.fDX,c.fDY,c.fDZ));e.vertices.push(new THREE.Vector3(c.fDX,c.fDY,-c.fDZ));e.vertices.push(new THREE.Vector3(c.fDX,-c.fDY,c.fDZ));e.vertices.push(new THREE.Vector3(c.fDX,-c.fDY,-c.fDZ));e.vertices.push(new THREE.Vector3(-c.fDX,c.fDY,-c.fDZ));e.vertices.push(new THREE.Vector3(-c.fDX,c.fDY,c.fDZ));e.vertices.push(new THREE.Vector3(-c.fDX,-c.fDY,-c.fDZ));e.vertices.push(new THREE.Vector3(-c.fDX,-c.fDY,c.fDZ));var h=[0,2,1,2,3,1,4,6,5,6,7,5,4,5,1,5,0,1,7,6,2,6,3,2,5,7,0,7,2,0,1,3,4,3,6,4];var f=[1,0,0,-1,0,0,0,1,0,0,-1,0,0,0,1,0,0,-1];var b=new THREE.Color();var d=null;for(var i=0;i<h.length;i+=3){if(i%6===0){d=new THREE.Vector3(f[i/2],f[i/2+1],f[i/2+2])}var g=new THREE.Face3(h[i],h[i+1],h[i+2],d,b,0);e.faces.push(g)}return e};a.GEO.createPara=function(g){var c=g.fTxy,b=g.fTxz,k=g.fTyz;var j=[-g.fZ*b-c*g.fY-g.fX,-g.fY-g.fZ*k,-g.fZ,-g.fZ*b+c*g.fY-g.fX,g.fY-g.fZ*k,-g.fZ,-g.fZ*b+c*g.fY+g.fX,g.fY-g.fZ*k,-g.fZ,-g.fZ*b-c*g.fY+g.fX,-g.fY-g.fZ*k,-g.fZ,g.fZ*b-c*g.fY-g.fX,-g.fY+g.fZ*k,g.fZ,g.fZ*b+c*g.fY-g.fX,g.fY+g.fZ*k,g.fZ,g.fZ*b+c*g.fY+g.fX,g.fY+g.fZ*k,g.fZ,g.fZ*b-c*g.fY+g.fX,-g.fY+g.fZ*k,g.fZ];var d=[4,5,6,4,7,6,0,3,7,7,4,0,4,5,1,1,0,4,6,2,1,1,5,6,7,3,2,2,6,7,1,2,3,3,0,1];var h=new THREE.Geometry();for(var f=0;f<j.length;f+=3){h.vertices.push(new THREE.Vector3(j[f],j[f+1],j[f+2]))}var e=new THREE.Color();for(var f=0;f<d.length;f+=3){h.faces.push(new THREE.Face3(d[f],d[f+1],d[f+2],null,e,0))}h.computeFaceNormals();return h};a.GEO.createTrapezoid=function(d){var b;if(d._typename=="TGeoTrd1"){b=[-d.fDx1,d.fDY,-d.fDZ,d.fDx1,d.fDY,-d.fDZ,d.fDx1,-d.fDY,-d.fDZ,-d.fDx1,-d.fDY,-d.fDZ,-d.fDx2,d.fDY,d.fDZ,d.fDx2,d.fDY,d.fDZ,d.fDx2,-d.fDY,d.fDZ,-d.fDx2,-d.fDY,d.fDZ]}else{b=[-d.fDx1,d.fDy1,-d.fDZ,d.fDx1,d.fDy1,-d.fDZ,d.fDx1,-d.fDy1,-d.fDZ,-d.fDx1,-d.fDy1,-d.fDZ,-d.fDx2,d.fDy2,d.fDZ,d.fDx2,d.fDy2,d.fDZ,d.fDx2,-d.fDy2,d.fDZ,-d.fDx2,-d.fDy2,d.fDZ]}var g=[4,5,6,4,7,6,0,3,7,7,4,0,4,5,1,1,0,4,6,2,1,1,5,6,7,3,2,2,6,7,1,2,3,3,0,1];var f=new THREE.Geometry();for(var e=0;e<24;e+=3){f.vertices.push(new THREE.Vector3(b[e],b[e+1],b[e+2]))}var c=new THREE.Color();for(var e=0;e<36;e+=3){f.faces.push(new THREE.Face3(g[e],g[e+1],g[e+2],null,c,0))}f.computeFaceNormals();return f};a.GEO.createArb8=function(h){var n=[h.fXY[0][0],h.fXY[0][1],-h.fDZ,h.fXY[1][0],h.fXY[1][1],-h.fDZ,h.fXY[2][0],h.fXY[2][1],-h.fDZ,h.fXY[3][0],h.fXY[3][1],-h.fDZ,h.fXY[4][0],h.fXY[4][1],h.fDZ,h.fXY[5][0],h.fXY[5][1],h.fDZ,h.fXY[6][0],h.fXY[6][1],h.fDZ,h.fXY[7][0],h.fXY[7][1],h.fDZ];var e=[];var d=[4,5,6,4,7,6,0,3,7,7,4,0,4,5,1,1,0,4,6,2,1,1,5,6,7,3,2,2,6,7,1,2,3,3,0,1];var l=new THREE.Geometry();for(var g=0;g<8;++g){var o=g*3;if((g>0)&&(n[o]===n[o-3])&&(n[o+1]===n[o-2])&&(n[o+2]===n[o-1])){e[g]=e[g-1];continue}e[g]=l.vertices.length;l.vertices.push(new THREE.Vector3(n[o],n[o+1],n[o+2]))}var f=new THREE.Color();for(var g=0;g<36;g+=3){var m=e[d[g]],k=e[d[g+1]],j=e[d[g+2]];if((m!==k)&&(k!==j)&&(m!==j)){l.faces.push(new THREE.Face3(m,k,j,null,f,0))}}l.computeFaceNormals();return l};a.GEO.createSphere=function(c){var w=c.fRmax;var h=c.fRmin;var p=c.fPhi1+180;var s=c.fPhi2-c.fPhi1;var e=c.fTheta1;var q=c.fTheta2-c.fTheta1;var d=c.fNseg;var o=c.fNz;var g=new THREE.SphereGeometry(w,d,o,p*Math.PI/180,s*Math.PI/180,e*Math.PI/180,q*Math.PI/180);g.applyMatrix(new THREE.Matrix4().makeRotationX(Math.PI/2));var f=new THREE.Geometry();var x=new THREE.Color();for(var r=0;r<g.vertices.length;++r){f.vertices.push(g.vertices[r])}for(var r=0;r<g.faces.length;++r){var l=g.faces[r];f.faces.push(new THREE.Face3(l.a,l.b,l.c,null,x,0))}var B=f.vertices.length;var b=(h<=0);if(b){if((q===180)&&(s===360)){f.computeFaceNormals();return f}f.vertices.push(new THREE.Vector3(0,0,0))}else{var y=h/w;for(var r=0;r<g.vertices.length;++r){var m=g.vertices[r];f.vertices.push(new THREE.Vector3(y*m.x,y*m.y,y*m.z))}for(var r=0;r<g.faces.length;++r){var l=g.faces[r];f.faces.push(new THREE.Face3(B+l.a,B+l.b,B+l.c,null,x,0))}}if(q!==180){for(var A=0;A<d;++A){if(b){f.faces.push(new THREE.Face3(A+0,A+1,B,null,x,0))}else{f.faces.push(new THREE.Face3(A+0,A+1,A+B,null,x,0));f.faces.push(new THREE.Face3(A+1,A+B+1,A+B,null,x,0))}}var C=g.vertices.length-d-1;for(var A=C;A<C+d;++A){if(b){f.faces.push(new THREE.Face3(A+0,A+1,B,null,x,0))}else{f.faces.push(new THREE.Face3(A+0,A+1,A+B,null,x,0));f.faces.push(new THREE.Face3(A+1,A+B+1,A+B,null,x,0))}}}if(s!==360){for(var z=0;z<o;z++){var u=z*(d+1);var t=(z+1)*(d+1);if(b){f.faces.push(new THREE.Face3(u,t,B,null,x,0))}else{f.faces.push(new THREE.Face3(u,t,u+B,null,x,0));f.faces.push(new THREE.Face3(t,t+B,u+B,null,x,0))}}for(var z=0;z<o;z++){var u=(z+1)*(d+1)-1;var t=(z+2)*(d+1)-1;if(b){f.faces.push(new THREE.Face3(u,t,B,null,x,0))}else{f.faces.push(new THREE.Face3(u,t,u+B,null,x,0));f.faces.push(new THREE.Face3(t,t+B,u+B,null,x,0))}}}f.computeFaceNormals();return f};a.GEO.createTube=function(d){var f,z,e,y;if((d._typename=="TGeoCone")||(d._typename=="TGeoConeSeg")){f=d.fRmax2;z=d.fRmin2;e=d.fRmax1;y=d.fRmin1}else{f=e=d.fRmax;z=y=d.fRmin}var k=(z>0)||(y>0);if(k){if(z<=0){z=1e-7;console.warn("zero inner radius1 in tube - not yet supported")}if(y<=0){y=1e-7;console.warn("zero inner radius1 in tube - not yet supported")}}var j=0,p=360;if((d._typename=="TGeoConeSeg")||(d._typename=="TGeoTubeSeg")||(d._typename=="TGeoCtub")){j=d.fPhi1;p=d.fPhi2-d.fPhi1}var s=Math.floor(p/6);if(s<4){s=4}var g=(p<360)?1:0;var o=s+g;var A=j*Math.PI/180,c=p/s*Math.PI/180;var h=new Float32Array(o),m=new Float32Array(o);for(var x=0;x<o;++x){m[x]=Math.cos(A+x*c);h[x]=Math.sin(A+x*c)}var l=new THREE.Geometry();if(k){for(var x=0;x<o;++x){l.vertices.push(new THREE.Vector3(z*m[x],z*h[x],d.fDZ))}for(var x=0;x<o;++x){l.vertices.push(new THREE.Vector3(y*m[x],y*h[x],-d.fDZ))}}else{l.vertices.push(new THREE.Vector3(0,0,d.fDZ));l.vertices.push(new THREE.Vector3(0,0,-d.fDZ))}var v=l.vertices.length;for(var x=0;x<o;++x){l.vertices.push(new THREE.Vector3(f*m[x],f*h[x],d.fDZ))}for(var x=0;x<o;++x){l.vertices.push(new THREE.Vector3(e*m[x],e*h[x],-d.fDZ))}if(d._typename=="TGeoCtub"){for(var q=0;q<l.vertices.length;++q){var w=l.vertices[q];if(w.z<0){w.z=-d.fDz-(w.x*d.fNlow[0]+w.x*d.fNlow[1])/d.fNlow[2]}else{w.z=d.fDz-(w.y*d.fNhigh[0]+w.y*d.fNhigh[1])/d.fNhigh[2]}}}var t=new THREE.Color();if(k){for(var x=0;x<s;++x){var b=(g===1)?(x+1):(x+1)%s;l.faces.push(new THREE.Face3(x,o+x,b,null,t,0));l.faces.push(new THREE.Face3(o+x,o+b,b,null,t,0))}}for(var x=0;x<s;++x){var b=(g===1)?(x+1):(x+1)%s;l.faces.push(new THREE.Face3(v+x,v+o+x,v+b,null,t,0));l.faces.push(new THREE.Face3(v+o+x,v+o+b,v+b,null,t,0))}for(var u=0;u<s;++u){var r=(g===1)?(u+1):(u+1)%s;if(k){l.faces.push(new THREE.Face3(u,u+v,r,null,t,0));l.faces.push(new THREE.Face3(u+v,r+v,r,null,t,0))}else{l.faces.push(new THREE.Face3(u+v,0,r+v,null,t,0))}}for(var u=0;u<s;++u){var r=(g===1)?(u+1):(u+1)%s;if(k){l.faces.push(new THREE.Face3(o+u,o+u+v,o+r,null,t,0));l.faces.push(new THREE.Face3(o+u+v,o+r+v,o+r,null,t,0))}else{l.faces.push(new THREE.Face3(o+u+v,1,o+r+v,null,t,0))}}if(g===1){if(k){l.faces.push(new THREE.Face3(0,o,v+o,null,t,0));l.faces.push(new THREE.Face3(0,v+o,v,null,t,0))}else{l.faces.push(new THREE.Face3(0,1,v+o,null,t,0));l.faces.push(new THREE.Face3(0,v+o,v,null,t,0));console.log("very special case of tube with cut")}if(k){l.faces.push(new THREE.Face3(s,2*s+1,v+2*s+1,null,t,0));l.faces.push(new THREE.Face3(s,v+2*s+1,v+s,null,t,0))}else{l.faces.push(new THREE.Face3(0,1,v+2*s+1,null,t,0));l.faces.push(new THREE.Face3(0,v+2*s+1,v+s,null,t,0))}}l.computeFaceNormals();return l};a.GEO.createEltu=function(g){var i=new THREE.Geometry();var c=Math.floor(360/6);var j=new Float32Array(c),h=new Float32Array(c);for(var e=0;e<c;++e){var f=e/c*2*Math.PI;j[e]=g.fRmin*Math.cos(f);h[e]=g.fRmax*Math.sin(f)}for(var e=0;e<c;++e){i.vertices.push(new THREE.Vector3(j[e],h[e],-g.fDZ))}i.vertices.push(new THREE.Vector3(0,0,-g.fDZ));for(var e=0;e<c;++e){i.vertices.push(new THREE.Vector3(j[e],h[e],+g.fDZ))}i.vertices.push(new THREE.Vector3(0,0,g.fDZ));var d=new THREE.Color();for(var e=0;e<c;++e){var k=(e+1)%c;i.faces.push(new THREE.Face3(e,e+c+1,k,null,d,0));i.faces.push(new THREE.Face3(e+c+1,k+c+1,k,null,d,0))}for(var e=0;e<c;++e){i.faces.push(new THREE.Face3(e,(e+1)%c,c,null,d,0))}var b=c+1;for(var e=0;e<c;++e){i.faces.push(new THREE.Face3(b+e,b+(e+1)%c,b+c,null,d,0))}i.computeFaceNormals();return i};a.GEO.createTorus=function(b){var d=b.fR;var u=b.fRmin;var t=b.fRmax;var f=b.fDphi-b.fPhi1;var m=b.fPhi1;var c=30;var h=Math.floor(f/6);if(h<8){h=8}var e=new THREE.Geometry();var p=new THREE.Color();var s=new THREE.TorusGeometry(d,t,c,h,f*Math.PI/180);s.applyMatrix(new THREE.Matrix4().makeRotationZ(m*Math.PI/180));var i=new THREE.TorusGeometry(d,u,c,h,f*Math.PI/180);i.applyMatrix(new THREE.Matrix4().makeRotationZ(m*Math.PI/180));for(var k=0;k<i.vertices.length;++k){e.vertices.push(i.vertices[k])}for(var k=0;k<i.faces.length;++k){var g=i.faces[k];e.faces.push(new THREE.Face3(g.a,g.b,g.c,null,p,0))}var r=e.vertices.length;for(var k=0;k<s.vertices.length;++k){e.vertices.push(s.vertices[k])}for(var k=0;k<s.faces.length;++k){var g=s.faces[k];e.faces.push(new THREE.Face3(r+g.a,r+g.b,r+g.c,null,p,0))}if(f!==360){for(var q=0;q<c;q++){var o=q*(h+1);var l=(q+1)*(h+1);e.faces.push(new THREE.Face3(o,l,o+r,null,p,0));e.faces.push(new THREE.Face3(l,l+r,o+r,null,p,0))}for(var q=0;q<c;q++){var o=(q+1)*(h+1)-1;var l=(q+2)*(h+1)-1;e.faces.push(new THREE.Face3(o,l,o+r,null,p,0));e.faces.push(new THREE.Face3(l,l+r,o+r,null,p,0))}}e.computeFaceNormals();return e};a.GEO.createPolygon=function(e){var l=e.fPhi1,s=e.fDphi;var t=60;if(e._typename=="TGeoPgon"){t=e.fNedges}else{t=Math.floor(s/6);if(t<4){t=4}}var m=new THREE.Geometry();var u=new THREE.Color();var D=l*Math.PI/180,c=s/t*Math.PI/180;var j=new Float32Array(t+1),n=new Float32Array(t+1);for(var x=0;x<=t;++x){n[x]=Math.cos(D+x*c);j[x]=Math.sin(D+x*c)}var C=[[],[]],r=null,h=null;var G=t;if(s!==360){r=[];h=[];G+=1}for(var g=0;g<2;++g){var p=(g===0)?"fRmax":"fRmin";var o=m.vertices.length;for(var F=0;F<e.fNz;++F){C[g][F]=m.vertices.length;var k=e.fZ[F],E=e[p][F];if((F>0)&&(F<e.fNz-1)){if(((e.fZ[F-1]===k)&&(e[p][F-1]===E))||((e[p][F+1]===E)&&(e[p][F-1]===E))){C[g][F]=C[g][F-1];continue}}if(E<=0){E=0.000001}var w=m.vertices.length;for(var x=0;x<G;++x){m.vertices.push(new THREE.Vector3(E*n[x],E*j[x],k))}if(r!==null){if(g===0){r.push(new THREE.Vector2(E,k));h.push(w)}else{r.unshift(new THREE.Vector2(E,k));h.unshift(w)}}if(F>0){for(var x=0;x<t;++x){var b=(x+1)%G;m.faces.push(new THREE.Face3(o+x,w+x,w+b,null,u,0));m.faces.push(new THREE.Face3(o+x,w+b,o+b,null,u,0))}}o=w}}for(var q=0;q<2;++q){var z=(q===0)?C[1][0]:C[1][e.fNz-1];var B=(q===0)?C[0][0]:C[0][e.fNz-1];for(var x=0;x<t;++x){var b=(x+1)%G;m.faces.push(new THREE.Face3(B+x,z+x,z+b,null,u,0));m.faces.push(new THREE.Face3(B+x,z+b,B+b,null,u,0))}}if(r!==null){var d=[];if(r.length===e.fNz*2){for(var F=e.fNz-1;F>0;--F){if(e.fZ[F]===e.fZ[F-1]){continue}var A=2*e.fNz-1-F;d.push([A,F,F-1]);d.push([A,F-1,A+1])}}else{d=THREE.ShapeUtils.triangulateShape(r,[])}for(var v=0;v<d.length;++v){var y=d[v];m.faces.push(new THREE.Face3(h[y[0]],h[y[1]],h[y[2]],null,u,0))}for(var v=0;v<d.length;++v){var y=d[v];m.faces.push(new THREE.Face3(h[y[0]]+t,h[y[2]]+t,h[y[1]]+t,null,u,0))}}m.computeFaceNormals();return m};a.GEO.createXtru=function(k){var n=new THREE.Geometry();var l=new THREE.Color();var e=0,o=0;for(var j=0;j<k.fNz;++j){var b=k.fZ[j],d=k.fScale[j];e=o;o=n.vertices.length;for(var h=0;h<k.fNvert;++h){n.vertices.push(new THREE.Vector3(d*k.fX[h],d*k.fY[h],b))}if(j>0){for(var h=0;h<k.fNvert;++h){var m=(h+1)%k.fNvert;n.faces.push(new THREE.Face3(e+h,o+h,o+m,null,l,0));n.faces.push(new THREE.Face3(e+h,o+m,e+m,null,l,0))}}}var f=[];for(var h=0;h<k.fNvert;++h){f.push(new THREE.Vector2(k.fX[h],k.fY[h]))}var c=THREE.ShapeUtils.triangulateShape(f,[]);for(var g=0;g<c.length;++g){face=c[g];n.faces.push(new THREE.Face3(face[0],face[1],face[2],null,l,0));n.faces.push(new THREE.Face3(face[0]+o,face[1]+o,face[2]+o,null,l,0))}n.computeFaceNormals();return n};a.GEO.createParaboloid=function(d){var q=Math.round(360/6);var m=30;var e=new Float32Array(q),k=new Float32Array(q);for(var t=0;t<q;++t){k[t]=Math.cos(t/q*2*Math.PI);e[t]=Math.sin(t/q*2*Math.PI)}var j=new THREE.Geometry();var g=new THREE.Color();var u=-d.fDZ,w=d.fDZ,p=d.fRlo,r=d.fRhi;if(d.fA>=0){if(d.fB>u){u=d.fB}}else{if(d.fB<w){w=d.fB}}var n=Math.atan2(u,p),o=Math.atan2(w,r);var l=0,h=0;for(var x=0;x<=m+1;++x){var f=w,i=0;if((x===m+1)&&(h===0)){break}switch(x){case 0:f=u;i=p;break;case m:f=w;i=r;break;case m+1:f=w;i=0;break;default:var c=Math.tan(n+(o-n)*x/m);var v=c*c-4*d.fA*d.fB;i=0.5*(c+Math.sqrt(v))/d.fA;if(i<0.000001){i=0}f=i*c}var s=j.vertices.length;if(i===0){j.vertices.push(new THREE.Vector3(0,0,f))}else{for(var t=0;t<q;++t){j.vertices.push(new THREE.Vector3(i*k[t],i*e[t],f))}}if(x>0){for(var t=0;t<q;++t){var b=(t+1)%q;if(h===0){j.faces.push(new THREE.Face3(l,s+t,s+b,null,g,0))}else{if(i==0){j.faces.push(new THREE.Face3(l+t,s,l+b,null,g,0))}else{j.faces.push(new THREE.Face3(l+t,s+t,s+b,null,g,0));j.faces.push(new THREE.Face3(l+t,s+b,l+b,null,g,0))}}}}h=i;l=s}j.computeFaceNormals();return j};a.GEO.createHype=function(c){if((c.fTin===0)&&(c.fTout===0)){return a.GEO.createTube(c)}var n=Math.round(360/6);var m=30;var e=new Float32Array(n),j=new Float32Array(n);for(var q=0;q<n;++q){j[q]=Math.cos(q/n*2*Math.PI);e[q]=Math.sin(q/n*2*Math.PI)}var i=new THREE.Geometry();var f=new THREE.Color();var k=[[],[]];for(var d=0;d<2;++d){if((d===0)&&(c.fRmin<=0)){k[d][0]=i.vertices.length;i.vertices.push(new THREE.Vector3(0,0,-c.fDz));k[d][m]=i.vertices.length;i.vertices.push(new THREE.Vector3(0,0,c.fDz));continue}var l=0;var p=(d===0)?c.fRmin:c.fRmax;var t=(d===0)?c.fTinsq:c.fToutsq;for(var u=0;u<=m;++u){var g=-c.fDz+u/m*2*c.fDz;var h=Math.sqrt(p*p+t*g*g);var o=i.vertices.length;k[d][u]=o;for(var q=0;q<n;++q){i.vertices.push(new THREE.Vector3(h*j[q],h*e[q],g))}if(u>0){for(var q=0;q<n;++q){var b=(q+1)%n;i.faces.push(new THREE.Face3(l+q,o+q,o+b,null,f,0));i.faces.push(new THREE.Face3(l+q,o+b,l+b,null,f,0))}}l=o}}for(var u=0;u<=m;u+=m){var r=k[0][u],s=k[1][u];for(var q=0;q<n;++q){var b=(q+1)%n;if(c.fRmin<=0){i.faces.push(new THREE.Face3(r,s+q,s+b,null,f,0))}else{i.faces.push(new THREE.Face3(r+q,s+q,s+b,null,f,0));i.faces.push(new THREE.Face3(r+q,s+b,r+b,null,f,0))}}}i.computeFaceNormals();return i};a.GEO.createComposite=function(b){return null;var d=a.GEO.createGeometry(b.fNode.fLeft);var c=a.GEO.createGeometry(b.fNode.fRight);return d};a.GEO.createGeometry=function(b){switch(b._typename){case"TGeoBBox":return a.GEO.createCube(b);case"TGeoPara":return a.GEO.createPara(b);case"TGeoTrd1":case"TGeoTrd2":return a.GEO.createTrapezoid(b);case"TGeoArb8":case"TGeoTrap":case"TGeoGtra":return a.GEO.createArb8(b);case"TGeoSphere":return a.GEO.createSphere(b);case"TGeoCone":case"TGeoConeSeg":case"TGeoTube":case"TGeoTubeSeg":case"TGeoCtub":return a.GEO.createTube(b);case"TGeoEltu":return a.GEO.createEltu(b);case"TGeoTorus":return a.GEO.createTorus(b);case"TGeoPcon":case"TGeoPgon":return a.GEO.createPolygon(b);case"TGeoXtru":return a.GEO.createXtru(b);case"TGeoParaboloid":return a.GEO.createParaboloid(b);case"TGeoHype":return a.GEO.createHype(b);case"TGeoCompositeShape":return a.GEO.createComposite(b)}return null};a.EGeoVisibilityAtt={kVisOverride:a.BIT(0),kVisNone:a.BIT(1),kVisThis:a.BIT(2),kVisDaughters:a.BIT(3),kVisOneLevel:a.BIT(4),kVisStreamed:a.BIT(5),kVisTouched:a.BIT(6),kVisOnScreen:a.BIT(7),kVisContainers:a.BIT(12),kVisOnly:a.BIT(13),kVisBranch:a.BIT(14),kVisRaytrace:a.BIT(15)};a.TestGeoAttBit=function(b,c){if(!("fGeoAtt" in b)){return false}return(b.fGeoAtt&c)!=0};a.ToggleGeoAttBit=function(b,c){if(!("fGeoAtt" in b)){return false}b.fGeoAtt=b.fGeoAtt^(c&16777215)};a.TGeoPainter=function(b){a.TObjectPainter.call(this,b);this.Cleanup(true);if((b!==null)&&(b._typename.indexOf("TGeoVolume")===0)){b={_typename:"TGeoNode",fVolume:b,fName:"TopLevel"}}this._geometry=b};a.TGeoPainter.prototype=Object.create(a.TObjectPainter.prototype);a.TGeoPainter.prototype.CreateToolbar=function(c){if(this._toolbar!==null){return}var b=this;var d=[{name:"toImage",title:"Save as PNG",icon:a.ToolbarIcons.camera,click:function(){var f=b._renderer.domElement.toDataURL("image/png");f.replace("image/png","image/octet-stream");var e=document.createElement("a");if(typeof e.download==="string"){document.body.appendChild(e);e.download="geometry.png";e.href=f;e.click();document.body.removeChild(e)}}}];this._toolbar=new a.Toolbar(this.select_main(),[d])};a.TGeoPainter.prototype.GetObject=function(){return this._geometry};a.TGeoPainter.prototype.decodeOptions=function(c){var b={_grid:false,_bound:false,_debug:false,_full:false,maxlvl:-1,_axis:false,scale:new THREE.Vector3(1,1,1)};var d=a.GetUrlOption("_grid");if(d!==null&&d=="true"){b._grid=true}var d=a.GetUrlOption("_debug");if(d!==null&&d=="true"){b._debug=true;b._grid=true}if(d!==null&&d=="bound"){b._debug=true;b._grid=true;b._bound=true}if(d!==null&&d=="full"){b._debug=true;b._grid=true;b._full=true;b._bound=true}c=c.toLowerCase();if(c.indexOf("all")>=0){b.maxlvl=9999;c=c.replace("all"," ")}if(c.indexOf("limit")>=0){b.maxlvl=1111;c=c.replace("limit"," ")}if(c.indexOf("invx")>=0){b.scale.x=-1;c=c.replace("invx"," ")}if(c.indexOf("invy")>=0){b.scale.y=-1;c=c.replace("invy"," ")}if(c.indexOf("invz")>=0){b.scale.z=-1;c=c.replace("invz"," ")}var e=c.indexOf("maxlvl");if(e>=0){b.maxlvl=parseInt(c.substr(e+6,1));c=c.replace("maxlvl"+b.maxlvl," ")}if(c.indexOf("d")>=0){b._debug=true}if(c.indexOf("g")>=0){b._grid=true}if(c.indexOf("b")>=0){b._bound=true}if(c.indexOf("f")>=0){b._full=true}if(c.indexOf("a")>=0){b._axis=true;b._yup=false}if(c.indexOf("y")>=0){b._yup=true}if(c.indexOf("z")>=0){b._yup=false}return b};a.TGeoPainter.prototype.addControls=function(){if(this._controls!==null){return}var c=this;this.select_main().property("flex_block_drag",true);this._controls=new THREE.OrbitControls(this._camera,this._renderer.domElement);this._controls.enableDamping=true;this._controls.dampingFactor=0.25;this._controls.enableZoom=true;this._controls.target.copy(this._lookat);this._controls.update();this._controls.addEventListener("change",function(){c.Render3D(0)});if(this.options._debug||this.options._grid){this._tcontrols=new THREE.TransformControls(this._camera,this._renderer.domElement);this._scene.add(this._tcontrols);this._tcontrols.attach(this._toplevel);window.addEventListener("keydown",function(g){switch(g.keyCode){case 81:c._tcontrols.setSpace(c._tcontrols.space==="local"?"world":"local");break;case 17:c._tcontrols.setTranslationSnap(Math.ceil(c._overall_size)/50);c._tcontrols.setRotationSnap(THREE.Math.degToRad(15));break;case 84:c._tcontrols.setMode("translate");break;case 82:c._tcontrols.setMode("rotate");break;case 83:c._tcontrols.setMode("scale");break;case 187:case 107:c._tcontrols.setSize(c._tcontrols.size+0.1);break;case 189:case 109:c._tcontrols.setSize(Math.max(c._tcontrols.size-0.1,0.1));break}});window.addEventListener("keyup",function(g){switch(g.keyCode){case 17:c._tcontrols.setTranslationSnap(null);c._tcontrols.setRotationSnap(null);break}});this._tcontrols.addEventListener("change",function(){c.Render3D(0)})}var d=new THREE.Raycaster(),b=null;function e(h){d.setFromCamera(h,c._camera);var l=d.intersectObjects(c._scene.children,true);if(l.length>0){var k=null;for(var j=0;j<l.length;++j){if("emissive" in l[j].object.material){k=l[j].object;break}}if(k&&b!=k){b=k;var g=b.name;var m=b.parent;while((m!==undefined)&&(m!==null)){if("name" in m){g=m.name+"/"+g}m=m.parent}}}else{}}function f(j){var h=("offsetX" in j)?j.offsetX:j.layerX;var g=("offsetY" in j)?j.offsetY:j.layerY;var i={x:(h/c._renderer.domElement.width)*2-1,y:-(g/c._renderer.domElement.height)*2+1};e(i);j.preventDefault()}this._renderer.domElement.addEventListener("mousemove",f)};a.TGeoPainter.prototype.accountClear=function(){this._num_geom=0;this._num_vertices=0;this._num_faces=0;this._num_meshes=0};a.TGeoPainter.prototype.accountGeom=function(d,c){if(d===null){if(!("unsupported_shapes" in this)){this.unsupported_shapes=[]}if((c!==undefined)&&(this.unsupported_shapes.indexOf(c)<0)){this.unsupported_shapes.push(c);console.warn("Not supported "+c)}return}this._num_geom++;if(("vertices" in d)&&("faces" in d)){this._num_vertices+=d.vertices.length;this._num_faces+=d.faces.length}else{var b=d.getAttribute("position")}};a.TGeoPainter.prototype.accountMesh=function(b){if(b!==null){this._num_meshes++}};a.TGeoPainter.prototype.checkFlipping=function(p,o,i,l,b){var g=new THREE.Matrix4();g.multiplyMatrices(p.matrixWorld,o);if(g.determinant()>-0.9){return l}if(b){return null}var f=0,h=new THREE.Vector3(1,1,1);if(g.elements[0]===-1&&g.elements[1]===0&&g.elements[2]===0){h.x=-1;f++}if(g.elements[4]===0&&g.elements[5]===-1&&g.elements[6]===0){h.y=-1;f++}if(g.elements[8]===0&&g.elements[9]===0&&g.elements[10]===-1){h.z=-1;f++}if((f===0)||(f===2)){h.set(1,1,1);f=0;if(g.elements[0]+g.elements[1]+g.elements[2]===-1){h.x=-1;f++}if(g.elements[4]+g.elements[5]+g.elements[6]===-1){h.y=-1;f++}if(g.elements[8]+g.elements[9]+g.elements[10]===-1){h.z=-1;f++}if((f===0)||(f===2)){h.z=-h.z}}o.scale(h);var c="_geom";if(h.x<0){c+="X"}if(h.y<0){c+="Y"}if(h.z<0){c+="Z"}if(c in i){return i[c]}l=l.clone();l.scale(h.x,h.y,h.z);var k,j;for(var e=0;e<l.faces.length;++e){k=l.faces[e];j=k.b;k.b=k.c;k.c=j}l.computeFaceNormals();i[c]=l;this.accountGeom(l);return l};a.TGeoPainter.prototype.getNodeProperties=function(g,f){var l=g.fVolume;var c={shape:l.fShape};var m=null;var h=null;if(typeof g.fMatrix!="undefined"&&g.fMatrix!==null){if(g.fMatrix._typename=="TGeoTranslation"){m=g.fMatrix.fTranslation}else{if(g.fMatrix._typename=="TGeoRotation"){h=g.fMatrix.fRotationMatrix}else{if(g.fMatrix._typename=="TGeoCombiTrans"){if(typeof g.fMatrix.fTranslation!="undefined"&&g.fMatrix.fTranslation!==null){m=g.fMatrix.fTranslation}if(typeof g.fMatrix.fRotation!="undefined"&&g.fMatrix.fRotation!==null){h=g.fMatrix.fRotation.fRotationMatrix}}}}}if((g._typename=="TGeoNodeOffset")&&(g.fFinder!=null)){if((g.fFinder["_typename"]=="TGeoPatternX")||(g.fFinder["_typename"]=="TGeoPatternY")||(g.fFinder["_typename"]=="TGeoPatternZ")){var j=g.fFinder.fStart+(g.fIndex+0.5)*g.fFinder.fStep;if(m!==null){console.warn("translation exists - should we combine with "+g.fFinder["_typename"])}else{switch(g.fFinder["_typename"].charAt(11)){case"X":m=[j,0,0];break;case"Y":m=[0,j,0];break;case"Z":m=[0,0,j];break}}}else{if(g.fFinder["_typename"]=="TGeoPatternCylPhi"){var d=1,o=0;if(typeof g.fFinder["fSinCos"]==="undefined"){d=Math.cos((Math.PI/180)*(g.fFinder["fStart"]+(g.fIndex+0.5)*g.fFinder["fStep"]));o=Math.sin((Math.PI/180)*(g.fFinder["fStart"]+(g.fIndex+0.5)*g.fFinder["fStep"]))}else{d=g.fFinder["fSinCos"][2*g.fIndex+1];o=g.fFinder["fSinCos"][2*g.fIndex]}if(h===null){h=[d,-o,0,o,d,0,0,0,1]}else{console.warn("should we multiply rotation matrixes here??");h[0]=d;h[1]=-o;h[3]=o;h[4]=d}}else{console.warn("Unsupported pattern type "+g.fFinder["_typename"])}}}c.material=null;if(f){var n=false,k=1,i;if(l.fLineColor>=0){i=a.Painter.root_colors[l.fLineColor]}if(typeof l.fMedium!="undefined"&&l.fMedium!==null&&typeof l.fMedium["fMaterial"]!="undefined"&&l.fMedium["fMaterial"]!==null){var b=l.fMedium["fMaterial"]["fFillStyle"];var e=(b<3000||b>3100)?0:b-3000;if(e>0){n=true;k=(100-e)/100}if(i===undefined){i=a.Painter.root_colors[l.fMedium["fMaterial"]["fFillColor"]]}}if(i===undefined){i="lightgrey"}c.material=new THREE.MeshLambertMaterial({transparent:n,opacity:k,wireframe:false,color:i,side:THREE.DoubleSide,vertexColors:THREE.NoColors,overdraw:0})}c.matrix=new THREE.Matrix4();if(h!==null){c.matrix.set(h[0],h[1],h[2],0,h[3],h[4],h[5],0,h[6],h[7],h[8],0,0,0,0,1)}if(m!==null){c.matrix.setPosition(new THREE.Vector3(m[0],m[1],m[2]))}return c};a.TGeoPainter.prototype.getEveNodeProperties=function(f,g){var h={shape:f.fShape};h.material=null;if(g){var d=false,b=1;if(f.fRGBA[3]<1){d=true;b=f.fRGBA[3]}var c=new THREE.Color(f.fRGBALine[0],f.fRGBALine[1],f.fRGBALine[2]);var e=new THREE.Color(f.fRGBA[0],f.fRGBA[1],f.fRGBA[2]);h.material=new THREE.MeshLambertMaterial({transparent:d,opacity:b,wireframe:false,color:e,side:THREE.DoubleSide,vertexColors:THREE.NoColors,overdraw:0})}h.matrix=new THREE.Matrix4().set(f.fTrans[0],f.fTrans[4],f.fTrans[8],0,f.fTrans[1],f.fTrans[5],f.fTrans[9],0,f.fTrans[2],f.fTrans[6],f.fTrans[10],0,0,0,0,1);h.matrix.setPosition({x:f.fTrans[12],y:f.fTrans[13],z:f.fTrans[14]});return h};a.TGeoPainter.prototype.drawNode=function(){if((this._stack==null)||(this._stack.length==0)){return false}var i=this._stack[this._stack.length-1];var f=this.NodeKind(i.node);if(f<0){return false}var j=null;if(f===0){j=(i.node.fVolume.fNodes!==null)?i.node.fVolume.fNodes.arr:null}else{j=(i.node.fElements!==null)?i.node.fElements.arr:null}if("nchild" in i){if((j===null)||(j.length<=i.nchild)){this._stack.pop()}else{this._stack.push({toplevel:(i.mesh?i.mesh:i.toplevel),node:j[i.nchild++]})}return true}var b=null;if(f===0){b=this.getNodeProperties(i.node,i.node._visible)}else{b=this.getEveNodeProperties(i.node,i.node._visible)}var g=null;if((b.shape===null)&&i.node._visible){i.node._visible=false}if(i.node._visible){if(typeof b.shape._geom==="undefined"){b.shape._geom=a.GEO.createGeometry(b.shape);this.accountGeom(b.shape._geom,b.shape._typename)}g=b.shape._geom}else{if(this._dummy_material===undefined){this._dummy_material=new THREE.MeshLambertMaterial({transparent:true,opacity:0,wireframe:false,color:"white",vertexColors:THREE.NoColors,overdraw:0,depthWrite:false,depthTest:false,visible:false})}b.material=this._dummy_material}var c=(j!==null)&&(j.length>0);var h=false;if(i.main&&(this.options.scale!==null)){if((this.options.scale.x<0)||(this.options.scale.y<0)||(this.options.scale.z<0)){b.matrix.scale(this.options.scale)}}if(i.node._visible&&(g!==null)){g=this.checkFlipping(i.toplevel,b.matrix,b.shape,g,c);h=c&&(g===null)}if(g===null){g=new THREE.Geometry()}var l=new THREE.Mesh(g,b.material);l.applyMatrix(b.matrix);this.accountMesh(l);l.name=i.node.fName;i.toplevel.add(l);l.updateMatrixWorld();if(h){a.console("perform workaroud for flipping mesh with childs");b.matrix.identity();g=this.checkFlipping(l,b.matrix,b.shape,b.shape._geom,false);var e=new THREE.Mesh(g,b.material);e.applyMatrix(b.matrix);e.name="..";l.add(e);e.updateMatrixWorld()}if(this.options._debug&&(i.node._visible||this.options._full)){var d=new THREE.WireframeHelper(l);d.material.color.set(a.Painter.root_colors[i.node.fVolume.fLineColor]);d.material.linewidth=i.node.fVolume.fLineWidth;i.toplevel.add(d)}if(this.options._bound&&(i.node._visible||this.options._full)){var k=new THREE.BoxHelper(l);i.toplevel.add(k)}i.mesh=l;if((j===null)||(j.length==0)){this._stack.pop()}else{i.nchild=0}return true};a.TGeoPainter.prototype.NodeKind=function(b){if((b===undefined)||(b===null)||(typeof b!=="object")){return -1}return("fShape" in b)&&("fTrans" in b)?1:0};a.TGeoPainter.prototype.CountGeoVolumes=function(j,c,e){var g=this.NodeKind(j);if(g<0){return 0}if(e===undefined){e=0;if(!c){c={erase:true}}if(!("map" in c)){c.map=[]}c.viscnt=0;if(!("clear" in c)){c.clear=function(){for(var i=0;i<this.map.length;++i){delete this.map[i]._refcnt;delete this.map[i]._numchld;delete this.map[i]._visible}this.map=[];this.viscnt=0}}}var b=null,d=null,h=false;if(g===0){if((j.fVolume===undefined)||(j.fVolume===null)){return 0}d=j.fVolume.fShape;b=(j.fVolume.fNodes!==null)?j.fVolume.fNodes.arr:null;h=a.TestGeoAttBit(j.fVolume,a.EGeoVisibilityAtt.kVisOnScreen)||((e<c.maxlvl)&&a.TestGeoAttBit(j.fVolume,a.EGeoVisibilityAtt.kVisThis))}else{if(j.fShape===undefined){return 0}d=j.fShape;b=(j.fElements!==null)?j.fElements.arr:null;h=j.fRnrSelf}if("cnt" in c){if(c.cnt[e]===undefined){c.cnt[e]=0}c.cnt[e]+=1}if("_refcnt" in j){j._refcnt++}else{j._refcnt=1;j._numchld=0;c.map.push(j);if(h&&!("_visible" in j)&&(d!==null)){j._visible=true;c.viscnt++}if(b!==null){for(var f=0;f<b.length;++f){j._numchld+=this.CountGeoVolumes(b[f],c,e+1)}}}if((e===0)&&c.erase){c.clear()}return 1+j._numchld};a.TGeoPainter.prototype.SameMaterial=function(d,b){if((d===null)||(b===null)){return d===b}if(d.fVolume.fLineColor>=0){return(d.fVolume.fLineColor===b.fVolume.fLineColor)}var e=(d.fVolume.fMedium!==null)?d.fVolume.fMedium["fMaterial"]:null;var c=(b.fVolume.fMedium!==null)?b.fVolume.fMedium["fMaterial"]:null;if(e===c){return true}if((e===null)||(c===null)){return false}return(e.fFillStyle===c.fFillStyle)&&(e.fFillColor===c.fFillColor)};a.TGeoPainter.prototype.ScanUniqueVisVolumes=function(f,k,l){if((f===undefined)||(f===null)||(typeof f!=="object")||(f.fVolume===undefined)||(f.fVolume==null)){return 0}if(k===0){l.master=null;l.vis_unique=true;l.vis_master=null;l.same_material=true}var j=f._visible?1:0;if(f._refcnt>1){l.vis_unique=false}if(l.master!==null){if(!this.SameMaterial(l.master,f)){l.same_material=false}}var g=l.vis_unique;l.vis_unique=true;var b=l.master,d=l.same_material;l.master=f._visible?f:null;l.same_material=true;var h=(f.fVolume.fNodes!==null)?f.fVolume.fNodes.arr:null;var c=0;if(h!==null){for(var e=0;e<h.length;++e){c+=this.ScanUniqueVisVolumes(h[e],k+1,l)}}f._numvis=c;f._visunique=l.vis_unique;f._samematerial=l.same_material;if(f._samematerial){if(d&&(b!=null)&&(l.master!==null)){l.same_material=this.SameMaterial(b,l.master)}else{l.same_material=d}if(b!==null){l.master=b}}else{l.master=null;l.same_material=false}l.vis_unique=g&&f._visunique;return j+c};a.TGeoPainter.prototype.createScene=function(f,b,e,d){this._scene=new THREE.Scene();this._scene.fog=new THREE.Fog(16777215,500,300000);this._scene_width=b;this._scene_height=e;this._camera=new THREE.PerspectiveCamera(25,b/e,1,100000);this._renderer=f?new THREE.WebGLRenderer({antialias:true,logarithmicDepthBuffer:true,preserveDrawingBuffer:true}):new THREE.CanvasRenderer({antialias:true});this._renderer.setPixelRatio(d);this._renderer.setClearColor(16777215,1);this._renderer.setSize(b,e);var c=new THREE.PointLight(15724527);this._camera.add(c);c.position.set(10,10,10);this._camera.up=this.options._yup?new THREE.Vector3(0,1,0):new THREE.Vector3(0,0,1);this._scene.add(this._camera);this._toplevel=new THREE.Object3D();this._scene.add(this._toplevel);this._overall_size=10};a.TGeoPainter.prototype.startDrawGeometry=function(){if(this._geometry._typename=="TGeoNode"){this._nodedraw=true;this._stack=[{toplevel:this._toplevel,node:this._geometry,main:true}]}else{if(this._geometry._typename=="TEveGeoShapeExtract"){this._nodedraw=false;this._stack=[{toplevel:this._toplevel,node:this._geometry,main:true}]}}this.accountClear()};a.TGeoPainter.prototype.adjustCameraPosition=function(){var g=new THREE.Box3().setFromObject(this._toplevel);var d=g.max.x-g.min.x,b=g.max.y-g.min.y,h=g.max.z-g.min.z,f=(g.max.x+g.min.x)/2,e=(g.max.y+g.min.y)/2,c=(g.max.z+g.min.z)/2;this._overall_size=2*Math.max(d,b,h);this._camera.near=this._overall_size/200;this._camera.far=this._overall_size*500;this._camera.updateProjectionMatrix();if(this.options._yup){this._camera.position.set(f-this._overall_size,e+this._overall_size,c-this._overall_size)}else{this._camera.position.set(f-this._overall_size,e-this._overall_size,c+this._overall_size)}this._lookat=new THREE.Vector3(f,e,c);this._camera.lookAt(this._lookat);if(this._controls!==null){this._controls.target.copy(this._lookat);this._controls.update()}};a.TGeoPainter.prototype.completeScene=function(){if(this.options._debug||this.options._grid){if(this.options._full){var b=new THREE.BoxHelper(this._toplevel);this._scene.add(b)}this._scene.add(new THREE.AxisHelper(2*this._overall_size));this._scene.add(new THREE.GridHelper(Math.ceil(this._overall_size),Math.ceil(this._overall_size)/50));this.helpText("<font face='verdana' size='1' color='red'><center>Transform Controls<br>'T' translate | 'R' rotate | 'S' scale<br>'+' increase size | '-' decrease size<br>'W' toggle wireframe/solid display<br>keep 'Ctrl' down to snap to grid</center></font>")}};a.TGeoPainter.prototype.drawCount=function(){var d=new Date();var c={cnt:[],maxlvl:-1};var g=this.CountGeoVolumes(this._geometry,c);var f="Total number: "+g+"<br/>";for(var e=0;e<c.cnt.length;++e){if(c.cnt[e]!==0){f+=("  lvl"+e+": "+c.cnt[e]+"<br/>")}}f+="Unique volumes: "+c.map.length+"<br/>";if(c.viscnt===0){c.clear();c.maxlvl=9999;g=this.CountGeoVolumes(this._geometry,c)}f+="Visible volumes: "+c.viscnt+"<br/>";if(g<200000){this.ScanUniqueVisVolumes(this._geometry,0,c);for(var h=0;h<c.map.length;++h){if(c.map[h]._refcnt>1){f+=(c.map[h]._visible?"vis":"map")+h+" "+c.map[h].fName+"  nref:"+c.map[h]._refcnt+" chld:"+c.map[h]._numvis+"("+c.map[h]._numchld+") unique:"+c.map[h]._visunique+" same:"+c.map[h]._samematerial;if(c.map[h]._samematerial){if(c.map[h]._visunique&&(c.map[h]._numvis>0)){f+=" (can merge with childs in Worker)"}else{if((c.map[h]._refcnt>4)&&(c.map[h]._numvis>1)){f+=" (make sense merge in main thread)"}}}f+="<br/>"}}}var b=new Date();f+="Elapsed time: "+(b.getTime()-d.getTime())+"ms <br/>";this.select_main().style("overflow","auto").html(f);return this.DrawingReady()};a.TGeoPainter.prototype.DrawGeometry=function(d){if(typeof d!=="string"){d=""}if(d==="count"){return this.drawCount()}var c=this.size_for_3d();this.options=this.decodeOptions(d);if(!("_yup" in this.options)){this.options._yup=this.svg_canvas().empty()}this._webgl=a.Painter.TestWebGL();this._data={cnt:[],maxlvl:this.options.maxlvl};var f=this.CountGeoVolumes(this._geometry,this._data);if((f>0)&&(this._data.viscnt==0)&&(this.options.maxlvl<0)){this._data.clear();this._data.maxlvl=1111;f=this.CountGeoVolumes(this._geometry,this._data)}var g=this._webgl?10000000:10000;if((this._data.maxlvl===1111)&&(f>g)){var e=0;for(var b=1;b<this._data.cnt.length;++b){e+=this._data.cnt.cnt[b];if(e>g){this._data.maxlvl=b-1;this._data.clear();this.CountGeoVolumes(this._geometry,this._data);break}}}this.createScene(this._webgl,c.width,c.height,window.devicePixelRatio);this.add_3d_canvas(this._renderer.domElement);this.startDrawGeometry();this._startm=new Date().getTime();this._drawcnt=0;this.CreateToolbar({container:this.select_main().node()});return this.continueDraw()};a.TGeoPainter.prototype.continueDraw=function(){var e=new Date().getTime();var d="";while(true){if(this.drawNode()){this._drawcnt++;d="Creating meshes "+this._drawcnt}else{break}var b=new Date().getTime();if(b-e>300){a.progress(d);setTimeout(this.continueDraw.bind(this),0);return this}if(b-this._startm>100000){break}}var c=new Date().getTime();a.console("Create tm = "+(c-this._startm)+" geom "+this._num_geom+" vertices "+this._num_vertices+" faces "+this._num_faces+" meshes "+this._num_meshes);if(c-this._startm>300){a.progress("Rendering geometry");setTimeout(this.completeDraw.bind(this,true),0);return this}return this.completeDraw()};a.TGeoPainter.prototype.Render3D=function(d){if(d===undefined){d=5}if(d<=0){if("render_tmout" in this){clearTimeout(this["render_tmout"])}var c=new Date();this._renderer.render(this._scene,this._camera);var b=new Date();delete this["render_tmout"];if(this.first_render_tm===0){this.first_render_tm=b.getTime()-c.getTime();a.console("First render tm = "+this.first_render_tm);this.addControls()}return}if("render_tmout" in this){return}this["render_tmout"]=setTimeout(this.Render3D.bind(this,0),d)};a.TGeoPainter.prototype.completeDraw=function(b){this.adjustCameraPosition();this.completeScene();if(this.options._axis){var d=a.Create("TNamed");d._typename="TAxis3D";d._main=this;a.draw(this.divid,d)}this.Render3D();if(b){a.progress()}this._data.clear();var c=this;var e=this.select_main().node();if(e!==null){e.tabIndex=0;e.focus();e.onkeypress=function(f){if(!f){f=event}switch(f.keyCode){case 87:case 119:c.toggleWireFrame(c._scene);break}};e.onclick=function(f){e.focus()}}return this.DrawingReady()};a.TGeoPainter.prototype.Cleanup=function(b){if(b===undefined){this.helpText();if(this._scene!==null){this.deleteChildren(this._scene)}if(this._tcontrols!==null){this._tcontrols.dispose()}if(this._controls!==null){this._controls.dispose()}}this._scene=null;this._scene_width=0;this._scene_height=0;this._renderer=null;this._toplevel=null;this._stack=null;this._camera=null;this.first_render_tm=0;this._controls=null;this._tcontrols=null;this._toolbar=null};a.TGeoPainter.prototype.helpText=function(d){var e="jsroot_helptext";var b=d3.select("#"+e);var c=true;if((typeof d=="undefined")||(d==null)){if(b.empty()){return}b.property("stack").pop();if(b.property("stack").length==0){return b.remove()}d=b.property("stack")[b.property("stack").length-1];c=false}if(b.empty()){b=d3.select(document.body).append("div").attr("id",e).attr("class","progressbox").property("stack",new Array);b.append("p")}b.select("p").html(d);if(c){b.property("stack").push(d);b.property("showtm",new Date)}};a.TGeoPainter.prototype.CheckResize=function(){var c=this.pad_painter();if(c){if(!c.CheckCanvasResize(size,a.browser.isFirefox?false:true)){return false}}var b=this.size_for_3d();if((this._scene_width===b.width)&&(this._scene_height===b.height)){return false}if((b.width<10)||(b.height<10)){return}this._scene_width=b.width;this._scene_height=b.height;this._camera.aspect=this._scene_width/this._scene_height;this._camera.updateProjectionMatrix();this._renderer.setSize(this._scene_width,this._scene_height);this.Render3D();return true};a.TGeoPainter.prototype.ownedByTransformControls=function(c){var b=c.parent;while(b&&!(b instanceof THREE.TransformControls)){b=b.parent}return(b&&(b instanceof THREE.TransformControls))};a.TGeoPainter.prototype.toggleWireFrame=function(d){var b=this;var c=function(e){if(e.hasOwnProperty("material")&&!(e instanceof THREE.GridHelper)){if(!b.ownedByTransformControls(e)){e.material.wireframe=!e.material.wireframe}}};d.traverse(c);this.Render3D()};a.TGeoPainter.prototype.deleteChildren=function(f){if((typeof f.children!="undefined")&&(f.children instanceof Array)){for(var c=f.children.length-1;c>=0;c--){var b=f.children[c];this.deleteChildren(b);try{f.remove(f.children[c])}catch(d){}try{b.geometry.dispose();b.geometry=null}catch(d){}try{b.material.dispose();b.material=null}catch(d){}try{b.texture.dispose();b.texture=null}catch(d){}b=null;f.children[c]=null}f.children=null}f=null};a.Painter.drawGeometry=function(d,c,b){a.extend(this,new a.TGeoPainter(c));this.SetDivId(d,5);return this.DrawGeometry(b)};a.TAxis3DPainter=function(b){a.TObjectPainter.call(this,b);this.axis=b};a.TAxis3DPainter.prototype=Object.create(a.TObjectPainter.prototype);a.TAxis3DPainter.prototype.GetObject=function(){return this.axis};a.TAxis3DPainter.prototype.Draw3DAxis=function(){var b=this.main_painter();if((b===null)&&("_main" in this.axis)){b=this.axis._main}if((b===null)||(b._toplevel===undefined)){return console.warn("no geo object found for 3D axis drawing")}var c=new THREE.Box3().setFromObject(b._toplevel);this.xmin=c.min.x;this.xmax=c.max.x;this.ymin=c.min.y;this.ymax=c.max.y;this.zmin=c.min.z;this.zmax=c.max.z;this.options={Logx:false,Logy:false,Logz:false};this.size3d=0;this["DrawXYZ"]=a.Painter.HPainter_DrawXYZ;this.toplevel=b._toplevel;this.DrawXYZ();b.adjustCameraPosition();b.Render3D()};a.Painter.drawAxis3D=function(d,c,b){a.extend(this,new a.TAxis3DPainter(c));if(!("_main" in c)){this.SetDivId(d)}this.Draw3DAxis();return this.DrawingReady()};a.expandGeoList=function(c,b){if((b==null)||!("arr" in b)||(b.arr.length==0)){return}c._more=true;c._geolst=b;c._get=function(d,f,e){if("_geolst" in d){a.CallBack(e,d,d._geolst)}if("_geoobj" in d){return a.CallBack(e,d,d._geoobj)}a.CallBack(e,d,null)};c._expand=function(f,d){if(!("arr" in d)){return false}f._childs=[];for(var h in d.arr){var g=d.arr[h];var e={_kind:"ROOT."+g._typename,_name:g.fName,_title:g.fTitle,_parent:f,_geoobj:g};if(g._typename=="TGeoMaterial"){e._icon="img_geomaterial"}else{if(g._typename=="TGeoMedium"){e._icon="img_geomedium"}else{if(g._typename=="TGeoMixture"){e._icon="img_geomixture"}}}f._childs.push(e)}return true}};a.provideGeoVisStyle=function(c){var b="";if(a.TestGeoAttBit(c,a.EGeoVisibilityAtt.kVisThis)){b+=" geovis_this"}if(a.TestGeoAttBit(c,a.EGeoVisibilityAtt.kVisDaughters)){b+=" geovis_daughters"}return b};a.provideGeoMenu=function(f,c,d){if(!("_volume" in c)){return false}f.add("separator");var b=c._volume;function e(g){a.ToggleGeoAttBit(b,g);c._icon=c._icon.split(" ")[0]+a.provideGeoVisStyle(b);d.UpdateTreeNode(c)}f.addchk(a.TestGeoAttBit(b,a.EGeoVisibilityAtt.kVisNone),"Invisible",a.EGeoVisibilityAtt.kVisNone,e);f.addchk(a.TestGeoAttBit(b,a.EGeoVisibilityAtt.kVisThis),"Visible",a.EGeoVisibilityAtt.kVisThis,e);f.addchk(a.TestGeoAttBit(b,a.EGeoVisibilityAtt.kVisDaughters),"Daughters",a.EGeoVisibilityAtt.kVisDaughters,e);f.addchk(a.TestGeoAttBit(b,a.EGeoVisibilityAtt.kVisOneLevel),"1lvl daughters",a.EGeoVisibilityAtt.kVisOneLevel,e);return true};a.geoIconClick=function(b){if((b==null)||(b._volume==null)){return false}a.ToggleGeoAttBit(b._volume,a.EGeoVisibilityAtt.kVisDaughters);b._icon=b._icon.split(" ")[0]+a.provideGeoVisStyle(b._volume);return true};a.expandGeoVolume=function(e,g,b){if((e==null)||(g==null)){return false}var f={_kind:"ROOT.TGeoVolume",_name:(b!=null)?b:g.fName,_title:g.fTitle,_parent:e,_volume:g,_more:(g.fNodes!==undefined)&&(g.fNodes!==null),_menu:a.provideGeoMenu,_icon_click:a.geoIconClick,_get:function(i,k,j){if((i!=null)&&(i._volume!=null)){return a.CallBack(j,i,i._volume)}a.CallBack(j,i,null)}};if(f._more){f._expand=function(k,m){var l=m.fNodes["arr"];for(var j in l){a.expandGeoVolume(k,l[j]["fVolume"])}return true}}if(f._title==""){if(g._typename!="TGeoVolume"){f._title=g._typename}}if(g.fShape!=null){if(f._title==""){f._title=g.fShape._typename}switch(g.fShape._typename){case"TGeoArb8":f._icon="img_geoarb8";break;case"TGeoCone":f._icon="img_geocone";break;case"TGeoConeSeg":f._icon="img_geoconeseg";break;case"TGeoCompositeShape":f._icon="img_geocomposite";break;case"TGeoTube":f._icon="img_geotube";break;case"TGeoTubeSeg":f._icon="img_geotubeseg";break;case"TGeoPara":f._icon="img_geopara";break;case"TGeoParaboloid":f._icon="img_geoparab";break;case"TGeoPcon":f._icon="img_geopcon";break;case"TGeoPgon":f._icon="img_geopgon";break;case"TGeoShapeAssembly":f._icon="img_geoassembly";break;case"TGeoSphere":f._icon="img_geosphere";break;case"TGeoTorus":f._icon="img_geotorus";break;case"TGeoTrd1":f._icon="img_geotrd1";break;case"TGeoTrd2":f._icon="img_geotrd2";break;case"TGeoXtru":f._icon="img_geoxtru";break;case"TGeoTrap":f._icon="img_geotrap";break;case"TGeoGtra":f._icon="img_geogtra";break;case"TGeoEltu":f._icon="img_geoeltu";break;case"TGeoHype":f._icon="img_geohype";break;case"TGeoCtub":f._icon="img_geoctub";break}}if(!("_childs" in e)){e._childs=[]}if(!("_icon" in f)){f._icon=f._more?"img_geocombi":"img_geobbox"}f._icon+=a.provideGeoVisStyle(g);for(var d=0;d<1000000;d++){var c=f._name;if(c.length==0){c="item"}if(d>0){c+="_"+d}for(var h in e._childs){if(e._childs[h]["_name"]==c){c="";break}}if(c.length>0){if(d>0){f._name=c}break}}e._childs.push(f);return true};a.expandGeoManagerHierarchy=function(e,f){if((e==null)||(f==null)){return false}e._childs=[];var d={_name:"Materials",_kind:"Folder",_title:"list of materials"};a.expandGeoList(d,f.fMaterials);e._childs.push(d);var c={_name:"Media",_kind:"Folder",_title:"list of media"};a.expandGeoList(c,f.fMedia);e._childs.push(c);var b={_name:"Tracks",_kind:"Folder",_title:"list of tracks"};a.expandGeoList(b,f.fTracks);e._childs.push(b);a.expandGeoVolume(e,f.fMasterVolume,"Volume");return true};a.addDrawFunc({name:"TGeoVolumeAssembly",icon:"img_geoassembly",func:a.Painter.drawGeometry,expand:"JSROOT.expandGeoVolume",opt:"all;count;limit;maxlvl2"});a.addDrawFunc({name:"TAxis3D",func:a.Painter.drawAxis3D});return a.Painter}));